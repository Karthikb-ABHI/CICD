name: MTPREE-2.20

trigger:
  branches:
    include:
    - main

pool:
  name: MTPre

variables:
  - name: appPoolName
    value: 'CICDTest'
  - name: sourcePath
    value: 'E:\Temp\CICDTest_Temp'
  - name: publishPath
    value: 'E:\Deployment\CICDTest'
  - name: deployPath
    value: 'E:\DeployedProjects\CICDTest'
  - name: backupRootPath
    value: 'E:\Deployment\Backup\CICDTest'
  - name: buildConfiguration
    value: 'Release'

stages:
- stage: DeployStage
  displayName: Build and Deploy
  jobs:
  - job: BuildAndDeploy
    displayName: Build & Deploy to IIS
    steps:
    - checkout: self
      clean: true

    - task: PowerShell@2
      displayName: 'Stop App Pool (Graceful)'
      inputs:
        targetType: inline
        script: |
          try {
              $status = (Get-WebAppPoolState -Name "$(appPoolName)" -ErrorAction Stop).Value
              if ($status -eq "Stopped") {
                  Write-Host "##[section]App pool already stopped. Proceeding."
              } 
              else {
                  Write-Host "##[section]Stopping app pool..."
                  & "C:\Windows\System32\inetsrv\appcmd" stop apppool "/apppool.name:$(appPoolName)"
                  Start-Sleep -Seconds 10
                  $statusAfter = (Get-WebAppPoolState -Name "$(appPoolName)").Value
                  if ($statusAfter -ne "Stopped") {
                      throw "App pool failed to stop after stop command."
                  }
                  Write-Host "##[section]App pool successfully stopped."
              }
          }
          catch {
              Write-Host "##vso[task.logissue type=error]Failed to stop app pool: $_"
              exit 1
          }

    # [Rest of your tasks follow the same pattern...]

- stage: ApprovalStage
  displayName: Manual Approval
  dependsOn: DeployStage
  jobs:
  - job: WaitForApproval
    displayName: Wait for approval
    pool: server
    steps:
    - task: ManualValidation@0
      timeoutInMinutes: 60
      inputs:
        notifyUsers: |
          karthik.4-v@adityabirlacapital.com
        instructions: 'Please validate deployment and approve/reject'
        onTimeout: reject

- stage: RollbackStage
  displayName: Rollback
  dependsOn: ApprovalStage
  condition: or(eq(dependencies.ApprovalStage.result, 'Rejected'), eq(dependencies.ApprovalStage.result, 'TimedOut'))
  jobs:
  - job: RollbackJob
    displayName: Execute Rollback
    steps:
    - task: PowerShell@2
      displayName: 'Stop App Pool (Graceful)'
      inputs:
        targetType: inline
        script: |
          try {
              $status = (Get-WebAppPoolState -Name "$(appPoolName)" -ErrorAction Stop).Value
              if ($status -eq "Stopped") {
                  Write-Host "##[section]App pool already stopped. Proceeding."
              } 
              else {
                  & "C:\Windows\System32\inetsrv\appcmd" stop apppool "/apppool.name:$(appPoolName)"
                  Start-Sleep -Seconds 10
                  $statusAfter = (Get-WebAppPoolState -Name "$(appPoolName)").Value
                  if ($statusAfter -ne "Stopped") {
                      throw "App pool failed to stop after stop command."
                  }
              }
          }
          catch {
              Write-Host "##vso[task.logissue type=error]Failed to stop app pool: $_"
              exit 1
          }
    # [Rest of rollback tasks...]