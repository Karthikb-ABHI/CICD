name: MTPREE-2.20

trigger:
  branches:
    include:
      - main

pool:
  name: MTPre  # Your self-hosted agent pool

variables:
  appPoolName: 'CICDTest'
  sourcePath: 'E:\Temp\CICDTest_Temp'
  publishPath: 'E:\Deployment\CICDTest'
  deployPath: 'E:\DeployedProjects\CICDTest'
  backupRootPath: 'E:\Deployments\backup\CICDTest'
  buildConfiguration: 'Release'

stages:
# ======================= Build & Deploy ========================
- stage: DeployStage
  displayName: Build and Deploy
  jobs:
    - job: BuildAndDeploy
      displayName: Build & Deploy to IIS
      steps:
        - checkout: self
          clean: true

        - task: PowerShell@2
          displayName: 'Stop App Pool'
          inputs:
            targetType: 'inline'
            script: |
              C:\Windows\System32\inetsrv\appcmd.exe stop apppool /apppool.name:"$(appPoolName)"
              Start-Sleep -Seconds 60

        - task: PowerShell@2
          displayName: 'Backup Current Deployment (Compressed)'
          inputs:
            targetType: 'inline'
            script: |
              if (Test-Path "$(deployPath)") {
                $timestamp = Get-Date -Format 'yyyyMMddHHmmss'
                $backupPath = "$(backupRootPath)\CICDTest_$timestamp.zip"
                Compress-Archive -Path "$(deployPath)\*" -DestinationPath $backupPath -Force
                Write-Host "##vso[task.setvariable variable=latestBackupPath]$backupPath"
              }

        - task: PowerShell@2
          displayName: 'Restore Dependencies'
          inputs:
            targetType: 'inline'
            script: |
              dotnet restore

        - task: PowerShell@2
          displayName: 'Build Project'
          inputs:
            targetType: 'inline'
            script: |
              dotnet build --configuration $(buildConfiguration) --no-restore

        - task: PowerShell@2
          displayName: 'Publish and Compress Artifact'
          inputs:
            targetType: 'inline'
            script: |
              dotnet publish --configuration $(buildConfiguration) --output "$(sourcePath)"
              $timestamp = Get-Date -Format 'yyyyMMddHHmmss'
              if (-not (Test-Path "$(publishPath)")) {
                New-Item -Path "$(publishPath)" -ItemType Directory -Force | Out-Null
              }
              $zipPath = "$(publishPath)\CICDTest_Publish_$timestamp.zip"
              Compress-Archive -Path "$(sourcePath)\*" -DestinationPath $zipPath -Force
              Write-Host "##vso[task.setvariable variable=publishZipPath]$zipPath"

        - task: PowerShell@2
          displayName: 'Deploy to IIS Folder from Compressed Artifact'
          inputs:
            targetType: 'inline'
            script: |
              Remove-Item -Recurse -Force "$(deployPath)\*" -ErrorAction SilentlyContinue
              Expand-Archive -Path "$(publishZipPath)" -DestinationPath "$(deployPath)" -Force

        - task: PowerShell@2
          displayName: 'Start App Pool + Verify'
          inputs:
            targetType: 'inline'
            script: |
              C:\Windows\System32\inetsrv\appcmd.exe start apppool /apppool.name:"$(appPoolName)"
              Start-Sleep -Seconds 10
              $status = (Get-WebAppPoolState -Name "$(appPoolName)").Value
              if ($status -ne "Started") {
                Write-Error "App Pool failed to start"
              }

        - task: PowerShell@2
          displayName: 'Clean Temp Files + Old Archives'
          inputs:
            targetType: 'inline'
            script: |
              if (Test-Path "$(sourcePath)") {
                Remove-Item -Recurse -Force "$(sourcePath)\*" -ErrorAction SilentlyContinue
              }
              # Delete old compressed publish files
              Get-ChildItem "$(publishPath)" -Filter '*.zip' | Where-Object { $_.CreationTime -lt (Get-Date).AddDays(-15) } | Remove-Item -Force
              # Delete old backups
              Get-ChildItem "$(backupRootPath)" -Filter '*.zip' | Where-Object { $_.CreationTime -lt (Get-Date).AddDays(-15) } | Remove-Item -Force

# ======================= Manual Approval ========================
- stage: ApprovalStage
  displayName: Manual Sanity Check Approval
  dependsOn: DeployStage
  jobs:
    - job: WaitForApproval
      displayName: Wait for manual approval
      pool: server
      steps:
        - task: ManualValidation@0
          timeoutInMinutes: 60
          inputs:
            notifyUsers: |
              karthik@xxxy.com
              Raj@xxxy.com
            instructions: 'Please validate deployment sanity and approve or reject.'
            onTimeout: 'reject'

# ======================= Rollback ========================
- stage: RollbackStage
  displayName: Rollback Deployment
  dependsOn: ApprovalStage
  condition: or(
    eq(dependencies.ApprovalStage.jobs.WaitForApproval.result, 'Rejected'),
    eq(dependencies.ApprovalStage.jobs.WaitForApproval.result, 'TimedOut')
    )
  jobs:
    - job: RollbackJob
      displayName: Rollback to Previous Version
      steps:
        - task: PowerShell@2
          displayName: 'Stop App Pool'
          inputs:
            targetType: 'inline'
            script: |
              C:\Windows\System32\inetsrv\appcmd.exe stop apppool /apppool.name:"$(appPoolName)"
              Start-Sleep -Seconds 60

        - task: PowerShell@2
          displayName: 'Restore Backup'
          inputs:
            targetType: 'inline'
            script: |
              $backupPath = "$(latestBackupPath)"
              if (-not $backupPath) {
                Write-Error "Backup path variable not set. Cannot rollback!"
              }
              if (Test-Path $backupPath) {
                Remove-Item -Recurse -Force "$(deployPath)\*" -ErrorAction SilentlyContinue
                Expand-Archive -Path "$backupPath" -DestinationPath "$(deployPath)" -Force
              } else {
                Write-Error "Backup file not found. Cannot rollback!"
              }

        - task: PowerShell@2
          displayName: 'Start App Pool After Rollback'
          inputs:
            targetType: 'inline'
            script: |
              C:\Windows\System32\inetsrv\appcmd.exe start apppool /apppool.name:"$(appPoolName)"
              Start-Sleep -Seconds 10
              $status = (Get-WebAppPoolState -Name "$(appPoolName)").Value
              if ($status -ne "Started") {
                Write-Error "App Pool failed to start after rollback"

        - task: PowerShell@2
          displayName: 'Clean Old Archives'
          inputs:
            targetType: 'inline'
            script: |
              Get-ChildItem "$(publishPath)" -Filter '*.zip' | Where-Object { $_.CreationTime -lt (Get-Date).AddDays(-15) } | Remove-Item -Force
              Get-ChildItem "$(backupRootPath)" -Filter '*.zip' | Where-Object { $_.CreationTime -lt (Get-Date).AddDays(-15) } | Remove-Item -Force
