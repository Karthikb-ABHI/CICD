name: Build and Deploy .NET 8 App to Azure VM

trigger:
  branches:
    include:
      - main

pool:
  name: MTPreWEB  # Self-hosted agent pool

variables:
  appPoolName: 'healthinsurance'
  sourcePath: 'E:\Temp\CICDTest_Temp'
  deployPath: 'E:\DeployedProjects\CICDTest'
  backupPath: 'E:\Deployments\backup\CICDTest'
  buildConfiguration: 'Release'

  # Proxy and SSL Configuration
  HTTP_PROXY: 'http://185.46.212.88:80'
  HTTPS_PROXY: 'http://185.46.212.88:80'
  NO_PROXY: 'localhost,127.0.0.1'
  GIT_SSL_CAPATH: 'C:\Program Files\Git\mingw64\etc\ssl\certs'
  GIT_SSL_CAINFO: 'C:\Program Files\Git\mingw64\etc\ssl\certs\ca-bundle.crt'

stages:
# ======================= Build & Deploy ========================
- stage: DeployStage
  displayName: Build and Deploy
  jobs:
  - job: BuildAndDeploy
    displayName: Build & Deploy to IIS
    steps:

    - task: PowerShell@2
      displayName: 'Configure Git SSL'
      inputs:
        targetType: 'inline'
        script: |
          git config --global http.sslBackend schannel
          git config --global --unset http.sslCAInfo
          git config --global http.sslVerify true
          git config --global http.proxy $(HTTP_PROXY)

    - checkout: self
      clean: true
      fetchDepth: 1

    - task: PowerShell@2
      displayName: 'Stop App Pool'
      inputs:
        targetType: 'inline'
        script: |
          try {
            & "$env:SYSTEMROOT\System32\inetsrv\appcmd" stop apppool /apppool.name:"$(appPoolName)"
            Write-Host "App Pool stopped successfully"
          } catch {
            Write-Warning "Failed to stop App Pool: $_"
          }

    - task: PowerShell@2
      displayName: 'Backup Current Deployment'
      inputs:
        targetType: 'inline'
        script: |
          if (Test-Path "$(deployPath)") {
            if (Test-Path "$(backupPath)") {
              Remove-Item -Recurse -Force "$(backupPath)"
            }
            New-Item -ItemType Directory -Path "$(backupPath)" -Force | Out-Null
            Copy-Item -Path "$(deployPath)\*" -Destination "$(backupPath)" -Recurse -Force
            Write-Host "Backup created at $(backupPath)"
          } else {
            Write-Host "No existing deployment found - skipping backup"
          }

    - task: DotNetCoreCLI@2
      displayName: 'Restore Dependencies'
      inputs:
        command: 'restore'
        projects: '**/*.csproj'

    - task: DotNetCoreCLI@2
      displayName: 'Build Project'
      inputs:
        command: 'build'
        projects: '**/*.csproj'
        arguments: '--configuration $(buildConfiguration) --no-restore'

    - task: DotNetCoreCLI@2
      displayName: 'Publish Project'
      inputs:
        command: 'publish'
        publishWebProjects: true
        arguments: '--configuration $(buildConfiguration) --output $(sourcePath) --no-build'
        zipAfterPublish: false

    - task: PowerShell@2
      displayName: 'Deploy to IIS'
      inputs:
        targetType: 'inline'
        script: |
          if (Test-Path "$(deployPath)") {
            Remove-Item -Path "$(deployPath)\*" -Recurse -Force
          } else {
            New-Item -ItemType Directory -Path "$(deployPath)" -Force | Out-Null
          }

          Copy-Item -Path "$(sourcePath)\*" -Destination "$(deployPath)" -Recurse -Force
          Write-Host "Deployment completed to $(deployPath)"

    - task: PowerShell@2
      displayName: 'Start App Pool & Verify'
      inputs:
        targetType: 'inline'
        script: |
          & "$env:SYSTEMROOT\System32\inetsrv\appcmd" start apppool /apppool.name:"$(appPoolName)"
          Start-Sleep -Seconds 5
          $retryCount = 0
          $maxRetries = 3

          while ($retryCount -lt $maxRetries) {
            $status = (& "$env:SYSTEMROOT\System32\inetsrv\appcmd" list apppool /apppool.name:"$(appPoolName)" /text:state)
            if ($status -eq "Started") {
              Write-Host "App Pool started successfully"
              exit 0
            }
            $retryCount++
            Start-Sleep -Seconds 5
          }

          Write-Error "App Pool failed to start after $maxRetries attempts"
          exit 1

# ======================= Rollback ========================
- stage: RollbackStage
  displayName: Rollback Deployment
  dependsOn: DeployStage
  condition: failed()
  jobs:
  - job: RollbackJob
    displayName: Rollback to Previous Version
    steps:

    - task: PowerShell@2
      displayName: 'Stop App Pool'
      inputs:
        targetType: 'inline'
        script: |
          & "$env:SYSTEMROOT\System32\inetsrv\appcmd" stop apppool /apppool.name:"$(appPoolName)"

    - task: PowerShell@2
      displayName: 'Restore Backup'
      inputs:
        targetType: 'inline'
        script: |
          if (-not (Test-Path "$(backupPath)")) {
            Write-Error "##vso[task.logissue type=error]Backup folder not found at $(backupPath)"
            exit 1
          }

          Remove-Item -Path "$(deployPath)\*" -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "$(backupPath)\*" -Destination "$(deployPath)" -Recurse -Force
          Write-Host "Rollback completed successfully"

    - task: PowerShell@2
      displayName: 'Start App Pool'
      inputs:
        targetType: 'inline'
        script: |
          & "$env:SYSTEMROOT\System32\inetsrv\appcmd" start apppool /apppool.name:"$(appPoolName)"
          Start-Sleep -Seconds 5
          $status = (& "$env:SYSTEMROOT\System32\inetsrv\appcmd" list apppool /apppool.name:"$(appPoolName)" /text:state)
          if ($status -ne "Started") {
            Write-Error "##vso[task.logissue type=error]App Pool failed to start after rollback"
            exit 1
          }
          Write-Host "App Pool started successfully after rollback"
